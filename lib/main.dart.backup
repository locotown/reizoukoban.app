import 'package:flutter/material.dart';
import 'dart:convert';
import 'dart:html' as html;

void main() {
  runApp(const FreshAlertApp());
}

class FreshAlertApp extends StatelessWidget {
  const FreshAlertApp({super.key});

  @override
  Widget build(BuildContext context) {
    return MaterialApp(
      title: 'å†·è”µåº«ç•ª',
      debugShowCheckedModeBanner: false,
      theme: ThemeData(
        colorScheme: ColorScheme.fromSeed(
          seedColor: const Color(0xFF2196F3),
          brightness: Brightness.light,
        ),
        useMaterial3: true,
        fontFamily: 'Roboto',
      ),
      home: const MainNavigation(),
    );
  }
}

// ===== ãƒ¡ã‚¤ãƒ³ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ =====

class MainNavigation extends StatefulWidget {
  const MainNavigation({super.key});

  @override
  State<MainNavigation> createState() => _MainNavigationState();
}

class _MainNavigationState extends State<MainNavigation> {
  int _currentIndex = 0;
  List<FoodItem> _foods = [];
  List<FoodTemplate> _customTemplates = [];

  @override
  void initState() {
    super.initState();
    _loadData();
  }

  void _loadData() {
    setState(() {
      _foods = StorageService.loadFoods();
      _customTemplates = StorageService.loadCustomTemplates();
    });
  }

  void _updateFoods(List<FoodItem> foods) {
    setState(() {
      _foods = foods;
    });
  }

  void _updateCustomTemplates(List<FoodTemplate> templates) {
    setState(() {
      _customTemplates = templates;
    });
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      body: IndexedStack(
        index: _currentIndex,
        children: [
          DashboardScreen(
            foods: _foods,
            onFoodsChanged: _updateFoods,
          ),
          HomeScreen(
            foods: _foods,
            customTemplates: _customTemplates,
            onFoodsChanged: _updateFoods,
            onTemplatesChanged: _updateCustomTemplates,
          ),
        ],
      ),
      bottomNavigationBar: Container(
        decoration: BoxDecoration(
          color: Colors.white,
          boxShadow: [
            BoxShadow(
              color: Colors.black.withValues(alpha: 0.1),
              blurRadius: 10,
              offset: const Offset(0, -2),
            ),
          ],
        ),
        child: SafeArea(
          child: Padding(
            padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 8),
            child: Row(
              mainAxisAlignment: MainAxisAlignment.spaceAround,
              children: [
                _buildNavItem(0, Icons.home_rounded, 'ãƒ›ãƒ¼ãƒ '),
                _buildNavItem(1, Icons.add_circle_outline, 'ç™»éŒ²'),
              ],
            ),
          ),
        ),
      ),
    );
  }

  Widget _buildNavItem(int index, IconData icon, String label) {
    final isSelected = _currentIndex == index;
    return GestureDetector(
      onTap: () => setState(() => _currentIndex = index),
      child: Container(
        padding: const EdgeInsets.symmetric(horizontal: 24, vertical: 8),
        decoration: BoxDecoration(
          color: isSelected ? const Color(0xFF2196F3).withValues(alpha: 0.1) : Colors.transparent,
          borderRadius: BorderRadius.circular(12),
        ),
        child: Column(
          mainAxisSize: MainAxisSize.min,
          children: [
            Icon(
              icon,
              color: isSelected ? const Color(0xFF2196F3) : Colors.grey,
              size: 26,
            ),
            const SizedBox(height: 4),
            Text(
              label,
              style: TextStyle(
                color: isSelected ? const Color(0xFF2196F3) : Colors.grey,
                fontSize: 12,
                fontWeight: isSelected ? FontWeight.bold : FontWeight.normal,
              ),
            ),
          ],
        ),
      ),
    );
  }
}

// ===== ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«ï¼ˆãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ§‹é€ ï¼‰ =====

class Category {
  final String id;
  final String name;
  final String icon;
  final Color color;

  const Category({
    required this.id,
    required this.name,
    required this.icon,
    required this.color,
  });
}

// ===== ã‚µãƒ–ã‚«ãƒ†ã‚´ãƒªï¼ˆé£Ÿæã®ç¨®é¡åˆ¥ï¼‰ =====

class SubCategory {
  final String id;
  final String name;
  final String icon;
  final String parentCategoryId;  // ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³: Category.id ã¸ã®å¤–éƒ¨ã‚­ãƒ¼

  const SubCategory({
    required this.id,
    required this.name,
    required this.icon,
    required this.parentCategoryId,
  });
}

// ===== é£Ÿæãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ =====

class FoodTemplate {
  final String id;
  final String name;
  final String icon;
  final String categoryId;
  final String subCategoryId;  // ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³: SubCategory.id ã¸ã®å¤–éƒ¨ã‚­ãƒ¼
  final int defaultDays;

  const FoodTemplate({
    required this.id,
    required this.name,
    required this.icon,
    required this.categoryId,
    required this.subCategoryId,
    required this.defaultDays,
  });

  Map<String, dynamic> toJson() => {
    'id': id,
    'name': name,
    'icon': icon,
    'categoryId': categoryId,
    'subCategoryId': subCategoryId,
    'defaultDays': defaultDays,
  };

  factory FoodTemplate.fromJson(Map<String, dynamic> json) => FoodTemplate(
    id: json['id'],
    name: json['name'],
    icon: json['icon'],
    categoryId: json['categoryId'],
    subCategoryId: json['subCategoryId'] ?? 'other',
    defaultDays: json['defaultDays'],
  );
}

// ===== å®šæ•°: ã‚«ãƒ†ã‚´ãƒªãƒã‚¹ã‚¿ =====

const List<Category> defaultCategories = [
  Category(id: 'refrigerated', name: 'å†·è”µ', icon: 'ğŸ¥¬', color: Color(0xFF4CAF50)),
  Category(id: 'frozen', name: 'å†·å‡', icon: 'ğŸ§Š', color: Color(0xFF2196F3)),
  Category(id: 'pantry', name: 'å¸¸æ¸©', icon: 'ğŸ¥«', color: Color(0xFFFF9800)),
];

// ===== å®šæ•°: ã‚µãƒ–ã‚«ãƒ†ã‚´ãƒªãƒã‚¹ã‚¿ =====

const List<SubCategory> defaultSubCategories = [
  // å†·è”µ
  SubCategory(id: 'meat', name: 'è‚‰é¡', icon: 'ğŸ¥©', parentCategoryId: 'refrigerated'),
  SubCategory(id: 'fish', name: 'é­šä»‹é¡', icon: 'ğŸŸ', parentCategoryId: 'refrigerated'),
  SubCategory(id: 'vegetable', name: 'é‡èœ', icon: 'ğŸ¥¬', parentCategoryId: 'refrigerated'),
  SubCategory(id: 'fruit', name: 'ãƒ•ãƒ«ãƒ¼ãƒ„', icon: 'ğŸ', parentCategoryId: 'refrigerated'),
  SubCategory(id: 'dairy', name: 'ä¹³è£½å“', icon: 'ğŸ¥›', parentCategoryId: 'refrigerated'),
  SubCategory(id: 'other_ref', name: 'ãã®ä»–', icon: 'ğŸ±', parentCategoryId: 'refrigerated'),
  // å†·å‡
  SubCategory(id: 'frozen_meat', name: 'å†·å‡è‚‰', icon: 'ğŸ–', parentCategoryId: 'frozen'),
  SubCategory(id: 'frozen_fish', name: 'å†·å‡é­š', icon: 'ğŸ¦', parentCategoryId: 'frozen'),
  SubCategory(id: 'frozen_veg', name: 'å†·å‡é‡èœ', icon: 'ğŸ¥¦', parentCategoryId: 'frozen'),
  SubCategory(id: 'frozen_meal', name: 'å†·å‡é£Ÿå“', icon: 'ğŸ•', parentCategoryId: 'frozen'),
  SubCategory(id: 'ice_cream', name: 'ã‚¢ã‚¤ã‚¹', icon: 'ğŸ¦', parentCategoryId: 'frozen'),
  SubCategory(id: 'other_frozen', name: 'ãã®ä»–', icon: 'ğŸ“¦', parentCategoryId: 'frozen'),
  // å¸¸æ¸©
  SubCategory(id: 'bread', name: 'ãƒ‘ãƒ³é¡', icon: 'ğŸ', parentCategoryId: 'pantry'),
  SubCategory(id: 'noodle', name: 'éººé¡', icon: 'ğŸœ', parentCategoryId: 'pantry'),
  SubCategory(id: 'canned', name: 'ç¼¶è©°ãƒ»ç“¶è©°', icon: 'ğŸ¥«', parentCategoryId: 'pantry'),
  SubCategory(id: 'snack', name: 'ãŠè“å­', icon: 'ğŸª', parentCategoryId: 'pantry'),
  SubCategory(id: 'seasoning', name: 'èª¿å‘³æ–™', icon: 'ğŸ§‚', parentCategoryId: 'pantry'),
  SubCategory(id: 'other_pantry', name: 'ãã®ä»–', icon: 'ğŸ›’', parentCategoryId: 'pantry'),
];

// ===== ãƒ—ãƒªã‚»ãƒƒãƒˆé£Ÿæãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆï¼ˆç´°åˆ†åŒ–ç‰ˆï¼‰ =====

const List<FoodTemplate> defaultTemplates = [
  // === å†·è”µ - è‚‰é¡ ===
  FoodTemplate(id: 't1', name: 'è±šãƒ­ãƒ¼ã‚¹', icon: 'ğŸ¥©', categoryId: 'refrigerated', subCategoryId: 'meat', defaultDays: 3),
  FoodTemplate(id: 't2', name: 'è±šãƒãƒ©', icon: 'ğŸ¥“', categoryId: 'refrigerated', subCategoryId: 'meat', defaultDays: 3),
  FoodTemplate(id: 't3', name: 'é¶ã‚‚ã‚‚', icon: 'ğŸ—', categoryId: 'refrigerated', subCategoryId: 'meat', defaultDays: 2),
  FoodTemplate(id: 't4', name: 'é¶ã‚€ã­', icon: 'ğŸ—', categoryId: 'refrigerated', subCategoryId: 'meat', defaultDays: 2),
  FoodTemplate(id: 't5', name: 'ç‰›è‚‰', icon: 'ğŸ¥©', categoryId: 'refrigerated', subCategoryId: 'meat', defaultDays: 3),
  FoodTemplate(id: 't6', name: 'ã²ãè‚‰', icon: 'ğŸ–', categoryId: 'refrigerated', subCategoryId: 'meat', defaultDays: 2),
  FoodTemplate(id: 't7', name: 'ãƒ™ãƒ¼ã‚³ãƒ³', icon: 'ğŸ¥“', categoryId: 'refrigerated', subCategoryId: 'meat', defaultDays: 7),
  FoodTemplate(id: 't8', name: 'ãƒãƒ ', icon: 'ğŸ–', categoryId: 'refrigerated', subCategoryId: 'meat', defaultDays: 7),
  
  // === å†·è”µ - é­šä»‹é¡ ===
  FoodTemplate(id: 't9', name: 'ç§‹åˆ€é­š', icon: 'ğŸŸ', categoryId: 'refrigerated', subCategoryId: 'fish', defaultDays: 2),
  FoodTemplate(id: 't10', name: 'é®­', icon: 'ğŸŸ', categoryId: 'refrigerated', subCategoryId: 'fish', defaultDays: 2),
  FoodTemplate(id: 't11', name: 'é¯–', icon: 'ğŸŸ', categoryId: 'refrigerated', subCategoryId: 'fish', defaultDays: 2),
  FoodTemplate(id: 't12', name: 'ãƒã‚°ãƒ­', icon: 'ğŸ£', categoryId: 'refrigerated', subCategoryId: 'fish', defaultDays: 1),
  FoodTemplate(id: 't13', name: 'ã‚¨ãƒ“', icon: 'ğŸ¦', categoryId: 'refrigerated', subCategoryId: 'fish', defaultDays: 2),
  FoodTemplate(id: 't14', name: 'ã‚¤ã‚«', icon: 'ğŸ¦‘', categoryId: 'refrigerated', subCategoryId: 'fish', defaultDays: 2),
  FoodTemplate(id: 't15', name: 'ã‚¢ã‚µãƒª', icon: 'ğŸš', categoryId: 'refrigerated', subCategoryId: 'fish', defaultDays: 1),
  
  // === å†·è”µ - é‡èœ ===
  FoodTemplate(id: 't16', name: 'ã‚­ãƒ£ãƒ™ãƒ„', icon: 'ğŸ¥¬', categoryId: 'refrigerated', subCategoryId: 'vegetable', defaultDays: 7),
  FoodTemplate(id: 't17', name: 'ãƒ¬ã‚¿ã‚¹', icon: 'ğŸ¥¬', categoryId: 'refrigerated', subCategoryId: 'vegetable', defaultDays: 5),
  FoodTemplate(id: 't18', name: 'äººå‚', icon: 'ğŸ¥•', categoryId: 'refrigerated', subCategoryId: 'vegetable', defaultDays: 14),
  FoodTemplate(id: 't19', name: 'ç‰ã­ã', icon: 'ğŸ§…', categoryId: 'refrigerated', subCategoryId: 'vegetable', defaultDays: 30),
  FoodTemplate(id: 't20', name: 'ã˜ã‚ƒãŒã„ã‚‚', icon: 'ğŸ¥”', categoryId: 'refrigerated', subCategoryId: 'vegetable', defaultDays: 21),
  FoodTemplate(id: 't21', name: 'ãƒˆãƒãƒˆ', icon: 'ğŸ…', categoryId: 'refrigerated', subCategoryId: 'vegetable', defaultDays: 7),
  FoodTemplate(id: 't22', name: 'ãã‚…ã†ã‚Š', icon: 'ğŸ¥’', categoryId: 'refrigerated', subCategoryId: 'vegetable', defaultDays: 5),
  FoodTemplate(id: 't23', name: 'ã»ã†ã‚Œã‚“è‰', icon: 'ğŸ¥¬', categoryId: 'refrigerated', subCategoryId: 'vegetable', defaultDays: 3),
  FoodTemplate(id: 't24', name: 'ã‚‚ã‚„ã—', icon: 'ğŸŒ±', categoryId: 'refrigerated', subCategoryId: 'vegetable', defaultDays: 2),
  FoodTemplate(id: 't25', name: 'ãƒã‚®', icon: 'ğŸ§…', categoryId: 'refrigerated', subCategoryId: 'vegetable', defaultDays: 7),
  FoodTemplate(id: 't26', name: 'ãƒ”ãƒ¼ãƒãƒ³', icon: 'ğŸ«‘', categoryId: 'refrigerated', subCategoryId: 'vegetable', defaultDays: 7),
  FoodTemplate(id: 't27', name: 'ãªã™', icon: 'ğŸ†', categoryId: 'refrigerated', subCategoryId: 'vegetable', defaultDays: 5),
  
  // === å†·è”µ - ãƒ•ãƒ«ãƒ¼ãƒ„ ===
  FoodTemplate(id: 't28', name: 'ã‚Šã‚“ã”', icon: 'ğŸ', categoryId: 'refrigerated', subCategoryId: 'fruit', defaultDays: 14),
  FoodTemplate(id: 't29', name: 'ã¿ã‹ã‚“', icon: 'ğŸŠ', categoryId: 'refrigerated', subCategoryId: 'fruit', defaultDays: 14),
  FoodTemplate(id: 't30', name: 'ãƒãƒŠãƒŠ', icon: 'ğŸŒ', categoryId: 'refrigerated', subCategoryId: 'fruit', defaultDays: 5),
  FoodTemplate(id: 't31', name: 'ã„ã¡ã”', icon: 'ğŸ“', categoryId: 'refrigerated', subCategoryId: 'fruit', defaultDays: 3),
  FoodTemplate(id: 't32', name: 'ã¶ã©ã†', icon: 'ğŸ‡', categoryId: 'refrigerated', subCategoryId: 'fruit', defaultDays: 5),
  FoodTemplate(id: 't33', name: 'ã‚­ã‚¦ã‚¤', icon: 'ğŸ¥', categoryId: 'refrigerated', subCategoryId: 'fruit', defaultDays: 7),
  FoodTemplate(id: 't34', name: 'ãƒ¬ãƒ¢ãƒ³', icon: 'ğŸ‹', categoryId: 'refrigerated', subCategoryId: 'fruit', defaultDays: 21),
  FoodTemplate(id: 't35', name: 'æ¡ƒ', icon: 'ğŸ‘', categoryId: 'refrigerated', subCategoryId: 'fruit', defaultDays: 3),
  FoodTemplate(id: 't36', name: 'ãƒ¡ãƒ­ãƒ³', icon: 'ğŸˆ', categoryId: 'refrigerated', subCategoryId: 'fruit', defaultDays: 5),
  FoodTemplate(id: 't37', name: 'ã‚¹ã‚¤ã‚«', icon: 'ğŸ‰', categoryId: 'refrigerated', subCategoryId: 'fruit', defaultDays: 3),
  
  // === å†·è”µ - ä¹³è£½å“ ===
  FoodTemplate(id: 't38', name: 'ç‰›ä¹³', icon: 'ğŸ¥›', categoryId: 'refrigerated', subCategoryId: 'dairy', defaultDays: 7),
  FoodTemplate(id: 't39', name: 'åµ', icon: 'ğŸ¥š', categoryId: 'refrigerated', subCategoryId: 'dairy', defaultDays: 14),
  FoodTemplate(id: 't40', name: 'ãƒ¨ãƒ¼ã‚°ãƒ«ãƒˆ', icon: 'ğŸ¥£', categoryId: 'refrigerated', subCategoryId: 'dairy', defaultDays: 10),
  FoodTemplate(id: 't41', name: 'ãƒãƒ¼ã‚º', icon: 'ğŸ§€', categoryId: 'refrigerated', subCategoryId: 'dairy', defaultDays: 21),
  FoodTemplate(id: 't42', name: 'ãƒã‚¿ãƒ¼', icon: 'ğŸ§ˆ', categoryId: 'refrigerated', subCategoryId: 'dairy', defaultDays: 30),
  FoodTemplate(id: 't43', name: 'è±†è…', icon: 'ğŸ§ˆ', categoryId: 'refrigerated', subCategoryId: 'dairy', defaultDays: 5),
  FoodTemplate(id: 't44', name: 'ç´è±†', icon: 'ğŸ«˜', categoryId: 'refrigerated', subCategoryId: 'dairy', defaultDays: 7),
  
  // === å†·å‡ - è‚‰ ===
  FoodTemplate(id: 't45', name: 'å†·å‡è±šè‚‰', icon: 'ğŸ–', categoryId: 'frozen', subCategoryId: 'frozen_meat', defaultDays: 90),
  FoodTemplate(id: 't46', name: 'å†·å‡é¶è‚‰', icon: 'ğŸ—', categoryId: 'frozen', subCategoryId: 'frozen_meat', defaultDays: 90),
  FoodTemplate(id: 't47', name: 'å†·å‡ç‰›è‚‰', icon: 'ğŸ¥©', categoryId: 'frozen', subCategoryId: 'frozen_meat', defaultDays: 90),
  FoodTemplate(id: 't48', name: 'å†·å‡ã²ãè‚‰', icon: 'ğŸ–', categoryId: 'frozen', subCategoryId: 'frozen_meat', defaultDays: 60),
  
  // === å†·å‡ - é­š ===
  FoodTemplate(id: 't49', name: 'å†·å‡é®­', icon: 'ğŸŸ', categoryId: 'frozen', subCategoryId: 'frozen_fish', defaultDays: 60),
  FoodTemplate(id: 't50', name: 'å†·å‡ã‚¨ãƒ“', icon: 'ğŸ¦', categoryId: 'frozen', subCategoryId: 'frozen_fish', defaultDays: 90),
  FoodTemplate(id: 't51', name: 'å†·å‡ã‚¤ã‚«', icon: 'ğŸ¦‘', categoryId: 'frozen', subCategoryId: 'frozen_fish', defaultDays: 90),
  
  // === å†·å‡ - é‡èœ ===
  FoodTemplate(id: 't52', name: 'å†·å‡ãƒ–ãƒ­ãƒƒã‚³ãƒªãƒ¼', icon: 'ğŸ¥¦', categoryId: 'frozen', subCategoryId: 'frozen_veg', defaultDays: 60),
  FoodTemplate(id: 't53', name: 'å†·å‡æè±†', icon: 'ğŸ«›', categoryId: 'frozen', subCategoryId: 'frozen_veg', defaultDays: 90),
  FoodTemplate(id: 't54', name: 'ãƒŸãƒƒã‚¯ã‚¹ãƒ™ã‚¸ã‚¿ãƒ–ãƒ«', icon: 'ğŸ¥—', categoryId: 'frozen', subCategoryId: 'frozen_veg', defaultDays: 60),
  
  // === å†·å‡ - å†·å‡é£Ÿå“ ===
  FoodTemplate(id: 't55', name: 'å†·å‡é¤ƒå­', icon: 'ğŸ¥Ÿ', categoryId: 'frozen', subCategoryId: 'frozen_meal', defaultDays: 60),
  FoodTemplate(id: 't56', name: 'å†·å‡ãƒ”ã‚¶', icon: 'ğŸ•', categoryId: 'frozen', subCategoryId: 'frozen_meal', defaultDays: 90),
  FoodTemplate(id: 't57', name: 'å†·å‡ã”é£¯', icon: 'ğŸš', categoryId: 'frozen', subCategoryId: 'frozen_meal', defaultDays: 30),
  FoodTemplate(id: 't58', name: 'å†·å‡ã†ã©ã‚“', icon: 'ğŸœ', categoryId: 'frozen', subCategoryId: 'frozen_meal', defaultDays: 60),
  FoodTemplate(id: 't59', name: 'å†·å‡ãƒãƒ£ãƒ¼ãƒãƒ³', icon: 'ğŸ³', categoryId: 'frozen', subCategoryId: 'frozen_meal', defaultDays: 60),
  
  // === å†·å‡ - ã‚¢ã‚¤ã‚¹ ===
  FoodTemplate(id: 't60', name: 'ã‚¢ã‚¤ã‚¹ã‚¯ãƒªãƒ¼ãƒ ', icon: 'ğŸ¦', categoryId: 'frozen', subCategoryId: 'ice_cream', defaultDays: 180),
  FoodTemplate(id: 't61', name: 'ã‚¢ã‚¤ã‚¹ãƒãƒ¼', icon: 'ğŸ§', categoryId: 'frozen', subCategoryId: 'ice_cream', defaultDays: 180),
  
  // === å¸¸æ¸© - ãƒ‘ãƒ³ ===
  FoodTemplate(id: 't62', name: 'é£Ÿãƒ‘ãƒ³', icon: 'ğŸ', categoryId: 'pantry', subCategoryId: 'bread', defaultDays: 4),
  FoodTemplate(id: 't63', name: 'ãƒ­ãƒ¼ãƒ«ãƒ‘ãƒ³', icon: 'ğŸ¥', categoryId: 'pantry', subCategoryId: 'bread', defaultDays: 3),
  FoodTemplate(id: 't64', name: 'ãƒ•ãƒ©ãƒ³ã‚¹ãƒ‘ãƒ³', icon: 'ğŸ¥–', categoryId: 'pantry', subCategoryId: 'bread', defaultDays: 2),
  
  // === å¸¸æ¸© - éººé¡ ===
  FoodTemplate(id: 't65', name: 'ã‚«ãƒƒãƒ—éºº', icon: 'ğŸœ', categoryId: 'pantry', subCategoryId: 'noodle', defaultDays: 180),
  FoodTemplate(id: 't66', name: 'è¢‹éºº', icon: 'ğŸœ', categoryId: 'pantry', subCategoryId: 'noodle', defaultDays: 180),
  FoodTemplate(id: 't67', name: 'ãƒ‘ã‚¹ã‚¿', icon: 'ğŸ', categoryId: 'pantry', subCategoryId: 'noodle', defaultDays: 365),
  FoodTemplate(id: 't68', name: 'ãã†ã‚ã‚“', icon: 'ğŸœ', categoryId: 'pantry', subCategoryId: 'noodle', defaultDays: 365),
  
  // === å¸¸æ¸© - ç¼¶è©° ===
  FoodTemplate(id: 't69', name: 'ãƒ„ãƒŠç¼¶', icon: 'ğŸ¥«', categoryId: 'pantry', subCategoryId: 'canned', defaultDays: 365),
  FoodTemplate(id: 't70', name: 'ãƒˆãƒãƒˆç¼¶', icon: 'ğŸ¥«', categoryId: 'pantry', subCategoryId: 'canned', defaultDays: 365),
  FoodTemplate(id: 't71', name: 'ã‚³ãƒ¼ãƒ³ç¼¶', icon: 'ğŸ¥«', categoryId: 'pantry', subCategoryId: 'canned', defaultDays: 365),
  FoodTemplate(id: 't72', name: 'ãƒ•ãƒ«ãƒ¼ãƒ„ç¼¶', icon: 'ğŸ¥«', categoryId: 'pantry', subCategoryId: 'canned', defaultDays: 365),
  
  // === å¸¸æ¸© - ãŠè“å­ ===
  FoodTemplate(id: 't73', name: 'ã‚¯ãƒƒã‚­ãƒ¼', icon: 'ğŸª', categoryId: 'pantry', subCategoryId: 'snack', defaultDays: 60),
  FoodTemplate(id: 't74', name: 'ãƒãƒ§ã‚³ãƒ¬ãƒ¼ãƒˆ', icon: 'ğŸ«', categoryId: 'pantry', subCategoryId: 'snack', defaultDays: 180),
  FoodTemplate(id: 't75', name: 'ãƒãƒ†ãƒˆãƒãƒƒãƒ—ã‚¹', icon: 'ğŸ¥”', categoryId: 'pantry', subCategoryId: 'snack', defaultDays: 60),
  
  // === å¸¸æ¸© - èª¿å‘³æ–™ ===
  FoodTemplate(id: 't76', name: 'é†¤æ²¹', icon: 'ğŸ§‚', categoryId: 'pantry', subCategoryId: 'seasoning', defaultDays: 180),
  FoodTemplate(id: 't77', name: 'ã¿ã‚Šã‚“', icon: 'ğŸ¶', categoryId: 'pantry', subCategoryId: 'seasoning', defaultDays: 180),
  FoodTemplate(id: 't78', name: 'ãŠç±³', icon: 'ğŸŒ¾', categoryId: 'pantry', subCategoryId: 'seasoning', defaultDays: 60),
  
  // === å†·è”µ - ãã®ä»– ===
  FoodTemplate(id: 't79', name: 'è‚‰ã¾ã‚“', icon: 'ğŸ¥Ÿ', categoryId: 'refrigerated', subCategoryId: 'other_ref', defaultDays: 3),
  FoodTemplate(id: 't80', name: 'ã‚ã‚“ã¾ã‚“', icon: 'ğŸ¥®', categoryId: 'refrigerated', subCategoryId: 'other_ref', defaultDays: 3),
  FoodTemplate(id: 't81', name: 'æƒ£èœ', icon: 'ğŸ±', categoryId: 'refrigerated', subCategoryId: 'other_ref', defaultDays: 2),
  FoodTemplate(id: 't82', name: 'ã‚µãƒ©ãƒ€', icon: 'ğŸ¥—', categoryId: 'refrigerated', subCategoryId: 'other_ref', defaultDays: 1),
  FoodTemplate(id: 't83', name: 'ãŠå¼å½“', icon: 'ğŸ±', categoryId: 'refrigerated', subCategoryId: 'other_ref', defaultDays: 1),
  FoodTemplate(id: 't84', name: 'ãƒ‡ã‚¶ãƒ¼ãƒˆ', icon: 'ğŸ®', categoryId: 'refrigerated', subCategoryId: 'other_ref', defaultDays: 3),
  FoodTemplate(id: 't85', name: 'ã‚±ãƒ¼ã‚­', icon: 'ğŸ°', categoryId: 'refrigerated', subCategoryId: 'other_ref', defaultDays: 3),
  FoodTemplate(id: 't86', name: 'ãƒ—ãƒªãƒ³', icon: 'ğŸ®', categoryId: 'refrigerated', subCategoryId: 'other_ref', defaultDays: 5),
  
  // === å†·å‡ - ãã®ä»– ===
  FoodTemplate(id: 't87', name: 'å†·å‡ã‚±ãƒ¼ã‚­', icon: 'ğŸ°', categoryId: 'frozen', subCategoryId: 'other_frozen', defaultDays: 90),
  FoodTemplate(id: 't88', name: 'å†·å‡ãƒ‘ãƒ³', icon: 'ğŸ', categoryId: 'frozen', subCategoryId: 'other_frozen', defaultDays: 30),
  FoodTemplate(id: 't89', name: 'ä¿å†·å‰¤', icon: 'ğŸ§Š', categoryId: 'frozen', subCategoryId: 'other_frozen', defaultDays: 365),
  
  // === å¸¸æ¸© - ãã®ä»– ===
  FoodTemplate(id: 't90', name: 'ãƒ‰ãƒªãƒ³ã‚¯', icon: 'ğŸ§ƒ', categoryId: 'pantry', subCategoryId: 'other_pantry', defaultDays: 180),
  FoodTemplate(id: 't91', name: 'ãŠèŒ¶', icon: 'ğŸµ', categoryId: 'pantry', subCategoryId: 'other_pantry', defaultDays: 365),
  FoodTemplate(id: 't92', name: 'ã‚³ãƒ¼ãƒ’ãƒ¼', icon: 'â˜•', categoryId: 'pantry', subCategoryId: 'other_pantry', defaultDays: 365),
  FoodTemplate(id: 't93', name: 'ãƒ¬ãƒˆãƒ«ãƒˆ', icon: 'ğŸ›', categoryId: 'pantry', subCategoryId: 'other_pantry', defaultDays: 180),
  FoodTemplate(id: 't94', name: 'ãµã‚Šã‹ã‘', icon: 'ğŸš', categoryId: 'pantry', subCategoryId: 'other_pantry', defaultDays: 180),
];

class FoodItem {
  final String id;
  final String name;
  final String icon;
  final String categoryId;
  final DateTime expirationDate;
  final DateTime createdAt;

  FoodItem({
    required this.id,
    required this.name,
    required this.icon,
    required this.categoryId,
    required this.expirationDate,
    DateTime? createdAt,
  }) : createdAt = createdAt ?? DateTime.now();

  int get daysUntilExpiration =>
      expirationDate.difference(DateTime.now()).inDays;

  bool get isExpired => daysUntilExpiration < 0;
  bool get isWarning => daysUntilExpiration <= 3 && !isExpired;

  FoodItem copyWith({
    String? name,
    String? icon,
    String? categoryId,
    DateTime? expirationDate,
  }) {
    return FoodItem(
      id: id,
      name: name ?? this.name,
      icon: icon ?? this.icon,
      categoryId: categoryId ?? this.categoryId,
      expirationDate: expirationDate ?? this.expirationDate,
      createdAt: createdAt,
    );
  }

  Map<String, dynamic> toJson() => {
    'id': id,
    'name': name,
    'icon': icon,
    'categoryId': categoryId,
    'expirationDate': expirationDate.toIso8601String(),
    'createdAt': createdAt.toIso8601String(),
  };

  factory FoodItem.fromJson(Map<String, dynamic> json) => FoodItem(
    id: json['id'],
    name: json['name'],
    icon: json['icon'] ?? 'ğŸ½ï¸',
    categoryId: json['categoryId'],
    expirationDate: DateTime.parse(json['expirationDate']),
    createdAt: DateTime.parse(json['createdAt']),
  );
}

// ===== LocalStorageç®¡ç† =====

class StorageService {
  static const String _foodKey = 'fresh_alert_foods';
  static const String _customTemplateKey = 'fresh_alert_custom_templates';

  static List<FoodItem> loadFoods() {
    final data = html.window.localStorage[_foodKey];
    if (data == null || data.isEmpty) return [];
    try {
      final List<dynamic> jsonList = jsonDecode(data);
      return jsonList.map((json) => FoodItem.fromJson(json)).toList();
    } catch (e) {
      return [];
    }
  }

  static void saveFoods(List<FoodItem> foods) {
    final jsonList = foods.map((f) => f.toJson()).toList();
    html.window.localStorage[_foodKey] = jsonEncode(jsonList);
  }

  static List<FoodTemplate> loadCustomTemplates() {
    final data = html.window.localStorage[_customTemplateKey];
    if (data == null || data.isEmpty) return [];
    try {
      final List<dynamic> jsonList = jsonDecode(data);
      return jsonList.map((json) => FoodTemplate.fromJson(json)).toList();
    } catch (e) {
      return [];
    }
  }

  static void saveCustomTemplates(List<FoodTemplate> templates) {
    final jsonList = templates.map((t) => t.toJson()).toList();
    html.window.localStorage[_customTemplateKey] = jsonEncode(jsonList);
  }
}

// ===== é€šçŸ¥ã‚µãƒ¼ãƒ“ã‚¹ =====

class NotificationService {
  static Future<void> requestPermission() async {
    if (html.Notification.supported) {
      await html.Notification.requestPermission();
    }
  }

  static void showNotification(String title, String body) {
    if (html.Notification.supported &&
        html.Notification.permission == 'granted') {
      html.Notification(title, body: body, icon: 'ğŸš¨');
    }
  }

  static void checkExpirations(List<FoodItem> foods) {
    final warnings = foods.where((f) => f.isWarning || f.isExpired).toList();
    if (warnings.isNotEmpty) {
      final expired = warnings.where((f) => f.isExpired).length;
      final warning = warnings.where((f) => f.isWarning).length;
      String message = '';
      if (expired > 0) message += 'ğŸš¨ æœŸé™åˆ‡ã‚Œ: $expiredä»¶ ';
      if (warning > 0) message += 'âš ï¸ æœŸé™é–“è¿‘: $warningä»¶';
      showNotification('å†·è”µåº«ç•ªã‚¢ãƒ©ãƒ¼ãƒˆ', message);
    }
  }
}

// ===== ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ç”»é¢ =====

class DashboardScreen extends StatefulWidget {
  final List<FoodItem> foods;
  final Function(List<FoodItem>) onFoodsChanged;

  const DashboardScreen({
    super.key,
    required this.foods,
    required this.onFoodsChanged,
  });

  @override
  State<DashboardScreen> createState() => _DashboardScreenState();
}

class _DashboardScreenState extends State<DashboardScreen> with SingleTickerProviderStateMixin {
  late TabController _tabController;
  String _sortMode = 'expiration'; // 'expiration', 'status', 'added'
  
  int get _expiredCount => widget.foods.where((f) => f.isExpired).length;
  int get _warningCount => widget.foods.where((f) => f.isWarning).length;
  int get _safeCount => widget.foods.where((f) => !f.isExpired && !f.isWarning).length;

  @override
  void initState() {
    super.initState();
    _tabController = TabController(length: 4, vsync: this);
  }

  @override
  void dispose() {
    _tabController.dispose();
    super.dispose();
  }

  void _deleteFood(String id) {
    final updatedFoods = widget.foods.where((f) => f.id != id).toList();
    StorageService.saveFoods(updatedFoods);
    widget.onFoodsChanged(updatedFoods);
  }

  void _updateFood(FoodItem food) {
    final updatedFoods = widget.foods.map((f) => f.id == food.id ? food : f).toList();
    StorageService.saveFoods(updatedFoods);
    widget.onFoodsChanged(updatedFoods);
  }

  List<FoodItem> _getSortedFoods([String? categoryId]) {
    final foods = categoryId == null
        ? List<FoodItem>.from(widget.foods)
        : widget.foods.where((f) => f.categoryId == categoryId).toList();
    switch (_sortMode) {
      case 'expiration':
        foods.sort((a, b) => a.expirationDate.compareTo(b.expirationDate));
        break;
      case 'status':
        foods.sort((a, b) {
          if (a.isExpired != b.isExpired) return a.isExpired ? -1 : 1;
          if (a.isWarning != b.isWarning) return a.isWarning ? -1 : 1;
          return a.expirationDate.compareTo(b.expirationDate);
        });
        break;
      case 'added':
        foods.sort((a, b) => b.createdAt.compareTo(a.createdAt));
        break;
    }
    return foods;
  }

  String _getTodayString() {
    final now = DateTime.now();
    final weekdays = ['æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ', 'æ—¥'];
    final weekday = weekdays[now.weekday - 1];
    return '${now.month}/${now.day}(${weekday})';
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: const Color(0xFFF5F7FA),
      appBar: AppBar(
        elevation: 0,
        backgroundColor: Colors.white,
        title: Row(
          mainAxisAlignment: MainAxisAlignment.spaceBetween,
          children: [
            Row(
              children: [
                const Text('ğŸ§Š', style: TextStyle(fontSize: 24)),
                const SizedBox(width: 8),
                const Text(
                  'å†·è”µåº«ç•ª',
                  style: TextStyle(
                    fontSize: 18,
                    fontWeight: FontWeight.bold,
                    color: Color(0xFF1A1A2E),
                  ),
                ),
                const SizedBox(width: 12),
                Container(
                  padding: const EdgeInsets.symmetric(horizontal: 10, vertical: 4),
                  decoration: BoxDecoration(
                    color: const Color(0xFF2196F3).withValues(alpha: 0.1),
                    borderRadius: BorderRadius.circular(12),
                  ),
                  child: Row(
                    mainAxisSize: MainAxisSize.min,
                    children: [
                      const Icon(Icons.today, size: 12, color: Color(0xFF2196F3)),
                      const SizedBox(width: 4),
                      Text(
                        _getTodayString(),
                        style: const TextStyle(
                          color: Color(0xFF2196F3),
                          fontSize: 11,
                          fontWeight: FontWeight.w600,
                        ),
                      ),
                    ],
                  ),
                ),
              ],
            ),
            Row(
              children: [
                if (_expiredCount > 0) _buildMiniTag('ğŸš¨', _expiredCount, const Color(0xFFE53935)),
                if (_expiredCount > 0) const SizedBox(width: 6),
                if (_warningCount > 0) _buildMiniTag('âš ï¸', _warningCount, const Color(0xFFFF9800)),
                if (_warningCount > 0) const SizedBox(width: 6),
                _buildMiniTag('âœ…', _safeCount, const Color(0xFF4CAF50)),
              ],
            ),
          ],
        ),
        bottom: TabBar(
          controller: _tabController,
          labelColor: const Color(0xFF2196F3),
          unselectedLabelColor: Colors.grey,
          indicatorColor: const Color(0xFF2196F3),
          indicatorWeight: 3,
          tabs: [
            const Tab(child: Row(
              mainAxisAlignment: MainAxisAlignment.center,
              children: [
                Text('ğŸ“‹', style: TextStyle(fontSize: 16)),
                SizedBox(width: 4),
                Text('å…¨ã¦', style: TextStyle(fontWeight: FontWeight.w600, fontSize: 13)),
              ],
            )),
            ...defaultCategories.map((cat) => Tab(
              child: Row(
                mainAxisAlignment: MainAxisAlignment.center,
                children: [
                  Text(cat.icon, style: const TextStyle(fontSize: 16)),
                  const SizedBox(width: 4),
                  Text(cat.name, style: const TextStyle(fontWeight: FontWeight.w600, fontSize: 13)),
                ],
              ),
            )),
          ],
        ),
      ),
      body: TabBarView(
        controller: _tabController,
        children: [
          _buildFoodList(null),
          ...defaultCategories.map((cat) => _buildFoodList(cat.id)),
        ],
      ),
    );
  }

  Widget _buildFoodList(String? categoryId) {
    final sortedFoods = _getSortedFoods(categoryId);
    final categoryName = categoryId == null
        ? 'ã™ã¹ã¦'
        : defaultCategories.firstWhere((c) => c.id == categoryId).name;

    return SingleChildScrollView(
      padding: const EdgeInsets.all(16),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [


          // é£Ÿæä¸€è¦§ãƒ˜ãƒƒãƒ€ãƒ¼ + ã‚½ãƒ¼ãƒˆ
          Row(
            mainAxisAlignment: MainAxisAlignment.spaceBetween,
            children: [
              Text(
                '${categoryId == null ? "ğŸ“‹" : defaultCategories.firstWhere((c) => c.id == categoryId).icon} ${categoryName}ã®é£Ÿæ',
                style: const TextStyle(fontSize: 16, fontWeight: FontWeight.bold),
              ),
              // ã‚½ãƒ¼ãƒˆåˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³
              GestureDetector(
                    onTap: () {
                      setState(() {
                        if (_sortMode == 'expiration') {
                          _sortMode = 'status';
                        } else if (_sortMode == 'status') {
                          _sortMode = 'added';
                        } else {
                          _sortMode = 'expiration';
                        }
                      });
                    },
                    child: Container(
                      padding: const EdgeInsets.symmetric(horizontal: 10, vertical: 6),
                      decoration: BoxDecoration(
                        color: const Color(0xFF2196F3).withValues(alpha: 0.1),
                        borderRadius: BorderRadius.circular(12),
                        border: Border.all(
                          color: const Color(0xFF2196F3).withValues(alpha: 0.3),
                        ),
                      ),
                      child: Row(
                        mainAxisSize: MainAxisSize.min,
                        children: [
                          Icon(
                            _sortMode == 'expiration'
                              ? Icons.schedule
                              : _sortMode == 'status'
                                ? Icons.priority_high
                                : Icons.history,
                            size: 14,
                            color: const Color(0xFF2196F3),
                          ),
                          const SizedBox(width: 4),
                          Text(
                            _sortMode == 'expiration'
                              ? 'æœŸé™é †'
                              : _sortMode == 'status'
                                ? 'ç·Šæ€¥åº¦é †'
                                : 'è¿½åŠ é †',
                            style: const TextStyle(
                              color: Color(0xFF2196F3),
                              fontSize: 12,
                              fontWeight: FontWeight.w600,
                            ),
                          ),
                        ],
                      ),
                    ),
              ),
            ],
          ),
          const SizedBox(height: 12),
              
          if (sortedFoods.isEmpty)
            Container(
                  padding: const EdgeInsets.all(40),
                  decoration: BoxDecoration(
                    color: Colors.white,
                    borderRadius: BorderRadius.circular(16),
                  ),
                  child: Center(
                    child: Column(
                      children: [
                        const Text('ğŸ§Š', style: TextStyle(fontSize: 48)),
                        const SizedBox(height: 12),
                        Text(
                          'é£ŸæãŒã¾ã ã‚ã‚Šã¾ã›ã‚“',
                          style: TextStyle(color: Colors.grey[600], fontSize: 16),
                        ),
                        const SizedBox(height: 8),
                        const Text(
                          'ä¸‹ã®ã€Œç™»éŒ²ã€ã‚¿ãƒ–ã‹ã‚‰è¿½åŠ ã—ã¾ã—ã‚‡ã†',
                          style: TextStyle(color: Colors.grey),
                        ),
                      ],
                    ),
                  ),
          )
          else
            ...sortedFoods.map((food) => _buildFoodItem(food)),
        ],
      ),
    );
  }

  Widget _buildMiniTag(String icon, int count, Color color) {
    return Container(
      padding: const EdgeInsets.symmetric(horizontal: 8, vertical: 4),
      decoration: BoxDecoration(
        color: color.withValues(alpha: 0.1),
        borderRadius: BorderRadius.circular(12),
      ),
      child: Row(
        mainAxisSize: MainAxisSize.min,
        children: [
          Text(icon, style: const TextStyle(fontSize: 12)),
          const SizedBox(width: 4),
          Text(
            '$count',
            style: TextStyle(
              color: color,
              fontWeight: FontWeight.bold,
              fontSize: 12,
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildFoodItem(FoodItem food) {
    final category = defaultCategories.firstWhere(
      (c) => c.id == food.categoryId,
      orElse: () => defaultCategories.first,
    );

    Color statusColor;
    String statusText;
    
    if (food.isExpired) {
      statusColor = const Color(0xFFE53935);
      statusText = 'æœŸé™åˆ‡ã‚Œ';
    } else if (food.isWarning) {
      statusColor = const Color(0xFFFF9800);
      statusText = 'ã‚ã¨${food.daysUntilExpiration}æ—¥';
    } else {
      statusColor = const Color(0xFF4CAF50);
      statusText = 'ã‚ã¨${food.daysUntilExpiration}æ—¥';
    }

    return Dismissible(
      key: Key(food.id),
      direction: DismissDirection.endToStart,
      background: Container(
        alignment: Alignment.centerRight,
        padding: const EdgeInsets.only(right: 20),
        margin: const EdgeInsets.only(bottom: 8),
        decoration: BoxDecoration(
          color: Colors.red,
          borderRadius: BorderRadius.circular(12),
        ),
        child: const Icon(Icons.delete, color: Colors.white),
      ),
      onDismissed: (_) => _deleteFood(food.id),
      child: GestureDetector(
        onTap: () => _showEditDialog(food, category),
        child: Container(
          margin: const EdgeInsets.only(bottom: 8),
          padding: const EdgeInsets.all(12),
          decoration: BoxDecoration(
            color: Colors.white,
            borderRadius: BorderRadius.circular(12),
            border: food.isExpired 
              ? Border.all(color: const Color(0xFFE53935), width: 1.5)
              : null,
          ),
          child: Row(
            children: [
              Container(
                width: 44,
                height: 44,
                decoration: BoxDecoration(
                  color: category.color.withValues(alpha: 0.1),
                  borderRadius: BorderRadius.circular(10),
                ),
                child: Center(child: Text(food.icon, style: const TextStyle(fontSize: 22))),
              ),
              const SizedBox(width: 12),
              Expanded(
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Text(
                      food.name,
                      style: const TextStyle(fontWeight: FontWeight.w600, fontSize: 15),
                    ),
                    Text(
                      '${category.name} â€¢ ï½ ${food.expirationDate.month}/${food.expirationDate.day}',
                      style: TextStyle(color: Colors.grey[600], fontSize: 12),
                    ),
                  ],
                ),
              ),
              Container(
                padding: const EdgeInsets.symmetric(horizontal: 10, vertical: 4),
                decoration: BoxDecoration(
                  color: statusColor.withValues(alpha: 0.1),
                  borderRadius: BorderRadius.circular(12),
                ),
                child: Text(
                  statusText,
                  style: TextStyle(
                    color: statusColor,
                    fontWeight: FontWeight.bold,
                    fontSize: 12,
                  ),
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }

  void _showEditDialog(FoodItem food, Category category) {
    DateTime selectedDate = food.expirationDate;

    showModalBottomSheet(
      context: context,
      backgroundColor: Colors.transparent,
      builder: (context) => StatefulBuilder(
        builder: (context, setModalState) => Container(
          padding: const EdgeInsets.all(24),
          decoration: const BoxDecoration(
            color: Colors.white,
            borderRadius: BorderRadius.vertical(top: Radius.circular(24)),
          ),
          child: Column(
            mainAxisSize: MainAxisSize.min,
            children: [
              Container(
                width: 40,
                height: 4,
                decoration: BoxDecoration(
                  color: Colors.grey[300],
                  borderRadius: BorderRadius.circular(2),
                ),
              ),
              const SizedBox(height: 20),
              Row(
                children: [
                  Container(
                    width: 56,
                    height: 56,
                    decoration: BoxDecoration(
                      color: category.color.withValues(alpha: 0.1),
                      borderRadius: BorderRadius.circular(16),
                    ),
                    child: Center(child: Text(food.icon, style: const TextStyle(fontSize: 32))),
                  ),
                  const SizedBox(width: 16),
                  Expanded(
                    child: Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        Text(food.name, style: const TextStyle(fontSize: 20, fontWeight: FontWeight.bold)),
                        Text('${category.name}', style: TextStyle(color: Colors.grey[600])),
                      ],
                    ),
                  ),
                ],
              ),
              const SizedBox(height: 24),
              const Align(
                alignment: Alignment.centerLeft,
                child: Text('è³å‘³æœŸé™ã‚’å¤‰æ›´', style: TextStyle(fontWeight: FontWeight.w600)),
              ),
              const SizedBox(height: 12),
              GestureDetector(
                onTap: () async {
                  final date = await showDatePicker(
                    context: context,
                    initialDate: selectedDate,
                    firstDate: DateTime.now().subtract(const Duration(days: 30)),
                    lastDate: DateTime.now().add(const Duration(days: 365)),
                  );
                  if (date != null) setModalState(() => selectedDate = date);
                },
                child: Container(
                  padding: const EdgeInsets.all(16),
                  decoration: BoxDecoration(
                    color: const Color(0xFFF5F7FA),
                    borderRadius: BorderRadius.circular(12),
                    border: Border.all(color: category.color),
                  ),
                  child: Row(
                    children: [
                      Icon(Icons.calendar_today, color: category.color),
                      const SizedBox(width: 12),
                      Text(
                        '${selectedDate.year}/${selectedDate.month}/${selectedDate.day}',
                        style: const TextStyle(fontSize: 18, fontWeight: FontWeight.w600),
                      ),
                      const Spacer(),
                      const Icon(Icons.chevron_right, color: Colors.grey),
                    ],
                  ),
                ),
              ),
              const SizedBox(height: 12),
              Wrap(
                spacing: 8,
                children: [
                  _buildQuickDateButton('-1æ—¥', () => setModalState(() => selectedDate = selectedDate.subtract(const Duration(days: 1))), Colors.red),
                  _buildQuickDateButton('+1æ—¥', () => setModalState(() => selectedDate = selectedDate.add(const Duration(days: 1))), category.color),
                  _buildQuickDateButton('+3æ—¥', () => setModalState(() => selectedDate = selectedDate.add(const Duration(days: 3))), category.color),
                  _buildQuickDateButton('+7æ—¥', () => setModalState(() => selectedDate = selectedDate.add(const Duration(days: 7))), category.color),
                ],
              ),
              const SizedBox(height: 24),
              Row(
                children: [
                  Expanded(
                    child: OutlinedButton(
                      onPressed: () => Navigator.pop(context),
                      style: OutlinedButton.styleFrom(
                        padding: const EdgeInsets.symmetric(vertical: 14),
                        shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),
                      ),
                      child: const Text('ã‚­ãƒ£ãƒ³ã‚»ãƒ«'),
                    ),
                  ),
                  const SizedBox(width: 12),
                  Expanded(
                    flex: 2,
                    child: ElevatedButton(
                      onPressed: () {
                        final updatedFood = food.copyWith(expirationDate: selectedDate);
                        _updateFood(updatedFood);
                        Navigator.pop(context);
                      },
                      style: ElevatedButton.styleFrom(
                        backgroundColor: category.color,
                        foregroundColor: Colors.white,
                        padding: const EdgeInsets.symmetric(vertical: 14),
                        shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),
                      ),
                      child: const Text('ä¿å­˜ã™ã‚‹', style: TextStyle(fontWeight: FontWeight.bold)),
                    ),
                  ),
                ],
              ),
            ],
          ),
        ),
      ),
    );
  }

  Widget _buildQuickDateButton(String label, VoidCallback onTap, Color color) {
    return GestureDetector(
      onTap: onTap,
      child: Container(
        padding: const EdgeInsets.symmetric(horizontal: 14, vertical: 8),
        decoration: BoxDecoration(
          color: color.withValues(alpha: 0.1),
          borderRadius: BorderRadius.circular(20),
        ),
        child: Text(label, style: TextStyle(color: color, fontWeight: FontWeight.w600, fontSize: 13)),
      ),
    );
  }
}

// ===== ç™»éŒ²ç”»é¢ =====

class HomeScreen extends StatefulWidget {
  final List<FoodItem> foods;
  final List<FoodTemplate> customTemplates;
  final Function(List<FoodItem>) onFoodsChanged;
  final Function(List<FoodTemplate>) onTemplatesChanged;

  const HomeScreen({
    super.key,
    required this.foods,
    required this.customTemplates,
    required this.onFoodsChanged,
    required this.onTemplatesChanged,
  });

  @override
  State<HomeScreen> createState() => _HomeScreenState();
}

class _HomeScreenState extends State<HomeScreen> with SingleTickerProviderStateMixin {
  late TabController _tabController;
  String _selectedSubCategoryId = '';
  String _sortMode = 'added'; // 'expiration', 'status', 'added' - ç™»éŒ²ç”»é¢ã¯è¿½åŠ é †ãŒãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ

  List<FoodItem> get _foods => widget.foods;
  List<FoodTemplate> get _customTemplates => widget.customTemplates;
  List<FoodTemplate> get _allTemplates => [...defaultTemplates, ..._customTemplates];

  int get _expiredCount => _foods.where((f) => f.isExpired).length;
  int get _warningCount => _foods.where((f) => f.isWarning).length;
  int get _safeCount => _foods.where((f) => !f.isExpired && !f.isWarning).length;

  String _getTodayString() {
    final now = DateTime.now();
    final weekdays = ['æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ', 'æ—¥'];
    final weekday = weekdays[now.weekday - 1];
    return '${now.month}/${now.day}(${weekday})';
  }

  @override
  void initState() {
    super.initState();
    _tabController = TabController(length: 3, vsync: this);
    _tabController.addListener(() {
      setState(() {
        _selectedSubCategoryId = '';
      });
    });
  }

  void _addFood(FoodItem food) {
    final updatedFoods = [..._foods, food];
    StorageService.saveFoods(updatedFoods);
    widget.onFoodsChanged(updatedFoods);
    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(
        content: Text('${food.icon} ${food.name} ã‚’è¿½åŠ ã—ã¾ã—ãŸ'),
        backgroundColor: const Color(0xFF4CAF50),
        duration: const Duration(seconds: 1),
        behavior: SnackBarBehavior.floating,
      ),
    );
  }

  void _updateFood(FoodItem food) {
    final updatedFoods = _foods.map((f) => f.id == food.id ? food : f).toList();
    StorageService.saveFoods(updatedFoods);
    widget.onFoodsChanged(updatedFoods);
  }

  void _quickAddFromTemplate(FoodTemplate template) {
    final food = FoodItem(
      id: DateTime.now().millisecondsSinceEpoch.toString(),
      name: template.name,
      icon: template.icon,
      categoryId: template.categoryId,
      expirationDate: DateTime.now().add(Duration(days: template.defaultDays)),
    );
    _addFood(food);
  }

  void _addCustomTemplate(FoodTemplate template) {
    final updatedTemplates = [..._customTemplates, template];
    StorageService.saveCustomTemplates(updatedTemplates);
    widget.onTemplatesChanged(updatedTemplates);
  }

  void _deleteFood(String id) {
    final updatedFoods = _foods.where((f) => f.id != id).toList();
    StorageService.saveFoods(updatedFoods);
    widget.onFoodsChanged(updatedFoods);
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: const Color(0xFFF5F7FA),
      appBar: AppBar(
        elevation: 0,
        backgroundColor: Colors.white,
        title: Row(
          mainAxisAlignment: MainAxisAlignment.spaceBetween,
          children: [
            Row(
              children: [
                const Text('ğŸ§Š', style: TextStyle(fontSize: 24)),
                const SizedBox(width: 8),
                const Text(
                  'å†·è”µåº«ç•ª',
                  style: TextStyle(
                    fontSize: 18,
                    fontWeight: FontWeight.bold,
                    color: Color(0xFF1A1A2E),
                  ),
                ),
                const SizedBox(width: 12),
                Container(
                  padding: const EdgeInsets.symmetric(horizontal: 10, vertical: 4),
                  decoration: BoxDecoration(
                    color: const Color(0xFF2196F3).withValues(alpha: 0.1),
                    borderRadius: BorderRadius.circular(12),
                  ),
                  child: Row(
                    mainAxisSize: MainAxisSize.min,
                    children: [
                      const Icon(Icons.today, size: 12, color: Color(0xFF2196F3)),
                      const SizedBox(width: 4),
                      Text(
                        _getTodayString(),
                        style: const TextStyle(
                          color: Color(0xFF2196F3),
                          fontSize: 11,
                          fontWeight: FontWeight.w600,
                        ),
                      ),
                    ],
                  ),
                ),
              ],
            ),
            Row(
              children: [
                if (_expiredCount > 0) _buildMiniTag('ğŸš¨', _expiredCount, const Color(0xFFE53935)),
                if (_expiredCount > 0) const SizedBox(width: 6),
                if (_warningCount > 0) _buildMiniTag('âš ï¸', _warningCount, const Color(0xFFFF9800)),
                if (_warningCount > 0) const SizedBox(width: 6),
                _buildMiniTag('âœ…', _safeCount, const Color(0xFF4CAF50)),
              ],
            ),
          ],
        ),
        bottom: TabBar(
          controller: _tabController,
          labelColor: const Color(0xFF2196F3),
          unselectedLabelColor: Colors.grey,
          indicatorColor: const Color(0xFF2196F3),
          indicatorWeight: 3,
          tabs: defaultCategories.map((cat) => Tab(
            child: Row(
              mainAxisAlignment: MainAxisAlignment.center,
              children: [
                Text(cat.icon, style: const TextStyle(fontSize: 18)),
                const SizedBox(width: 6),
                Text(cat.name, style: const TextStyle(fontWeight: FontWeight.w600)),
              ],
            ),
          )).toList(),
        ),
      ),
      body: TabBarView(
        controller: _tabController,
        children: defaultCategories.map((cat) {
          final items = _foods.where((f) => f.categoryId == cat.id).toList();
          final subCategories = defaultSubCategories.where((s) => s.parentCategoryId == cat.id).toList();
          return _buildCategoryPage(items, subCategories, cat);
        }).toList(),
      ),
      floatingActionButton: FloatingActionButton.extended(
        onPressed: () => _showAddDialog(),
        backgroundColor: const Color(0xFF2196F3),
        icon: const Icon(Icons.edit, color: Colors.white),
        label: const Text('ã‚«ã‚¹ã‚¿ãƒ è¿½åŠ ', style: TextStyle(color: Colors.white, fontWeight: FontWeight.bold)),
      ),
    );
  }

  Widget _buildMiniTag(String icon, int count, Color color) {
    return Container(
      padding: const EdgeInsets.symmetric(horizontal: 8, vertical: 4),
      decoration: BoxDecoration(
        color: color.withValues(alpha: 0.1),
        borderRadius: BorderRadius.circular(12),
      ),
      child: Row(
        mainAxisSize: MainAxisSize.min,
        children: [
          Text(icon, style: const TextStyle(fontSize: 12)),
          const SizedBox(width: 4),
          Text(
            '$count',
            style: TextStyle(
              color: color,
              fontWeight: FontWeight.bold,
              fontSize: 12,
            ),
          ),
        ],
      ),
    );
  }

  List<FoodItem> _getSortedItems(List<FoodItem> items) {
    final sortedItems = List<FoodItem>.from(items);
    switch (_sortMode) {
      case 'expiration':
        sortedItems.sort((a, b) => a.expirationDate.compareTo(b.expirationDate));
        break;
      case 'status':
        sortedItems.sort((a, b) {
          if (a.isExpired != b.isExpired) return a.isExpired ? -1 : 1;
          if (a.isWarning != b.isWarning) return a.isWarning ? -1 : 1;
          return a.expirationDate.compareTo(b.expirationDate);
        });
        break;
      case 'added':
        sortedItems.sort((a, b) => b.createdAt.compareTo(a.createdAt));
        break;
    }
    return sortedItems;
  }

  Widget _buildCategoryPage(List<FoodItem> items, List<SubCategory> subCategories, Category category) {
    final sortedItems = _getSortedItems(items);
    
    return SingleChildScrollView(
      padding: const EdgeInsets.all(16),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          // ã‚µãƒ–ã‚«ãƒ†ã‚´ãƒªé¸æŠ
          Container(
            padding: const EdgeInsets.all(12),
            decoration: BoxDecoration(
              color: Colors.white,
              borderRadius: BorderRadius.circular(16),
              boxShadow: [
                BoxShadow(
                  color: Colors.black.withValues(alpha: 0.05),
                  blurRadius: 10,
                  offset: const Offset(0, 2),
                ),
              ],
            ),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Row(
                  children: [
                    Icon(Icons.category, color: category.color, size: 20),
                    const SizedBox(width: 8),
                    Text(
                      'ç¨®é¡ã‚’é¸æŠ',
                      style: TextStyle(
                        fontWeight: FontWeight.bold,
                        fontSize: 14,
                        color: category.color,
                      ),
                    ),
                  ],
                ),
                const SizedBox(height: 10),
                Wrap(
                  spacing: 8,
                  runSpacing: 8,
                  children: subCategories.map((sub) {
                    final isSelected = _selectedSubCategoryId == sub.id;
                    return GestureDetector(
                      onTap: () {
                        setState(() {
                          _selectedSubCategoryId = isSelected ? '' : sub.id;
                        });
                      },
                      child: Container(
                        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),
                        decoration: BoxDecoration(
                          color: isSelected ? category.color : category.color.withValues(alpha: 0.1),
                          borderRadius: BorderRadius.circular(20),
                        ),
                        child: Row(
                          mainAxisSize: MainAxisSize.min,
                          children: [
                            Text(sub.icon, style: const TextStyle(fontSize: 16)),
                            const SizedBox(width: 4),
                            Text(
                              sub.name,
                              style: TextStyle(
                                color: isSelected ? Colors.white : category.color,
                                fontWeight: FontWeight.w600,
                                fontSize: 12,
                              ),
                            ),
                          ],
                        ),
                      ),
                    );
                  }).toList(),
                ),
              ],
            ),
          ),
          const SizedBox(height: 16),
          
          // ãƒ¯ãƒ³ã‚¿ãƒƒãƒ—è¿½åŠ ã‚»ã‚¯ã‚·ãƒ§ãƒ³
          if (_selectedSubCategoryId.isNotEmpty) ...[
            _buildTemplateSection(category),
            const SizedBox(height: 16),
          ],
          
          // ç™»éŒ²æ¸ˆã¿ã‚¢ã‚¤ãƒ†ãƒ ã‚»ã‚¯ã‚·ãƒ§ãƒ³ + ã‚½ãƒ¼ãƒˆ
          Row(
            mainAxisAlignment: MainAxisAlignment.spaceBetween,
            children: [
              Row(
                children: [
                  Text(category.icon, style: const TextStyle(fontSize: 20)),
                  const SizedBox(width: 8),
                  Text(
                    '${category.name}ã®é£Ÿæ',
                    style: const TextStyle(fontWeight: FontWeight.bold, fontSize: 16),
                  ),
                  const SizedBox(width: 8),
                  Container(
                    padding: const EdgeInsets.symmetric(horizontal: 10, vertical: 4),
                    decoration: BoxDecoration(
                      color: category.color.withValues(alpha: 0.1),
                      borderRadius: BorderRadius.circular(12),
                    ),
                    child: Text(
                      '${items.length}ä»¶',
                      style: TextStyle(color: category.color, fontWeight: FontWeight.bold, fontSize: 12),
                    ),
                  ),
                ],
              ),
              // ã‚½ãƒ¼ãƒˆåˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³
              GestureDetector(
                onTap: () {
                  setState(() {
                    if (_sortMode == 'added') {
                      _sortMode = 'expiration';
                    } else if (_sortMode == 'expiration') {
                      _sortMode = 'status';
                    } else {
                      _sortMode = 'added';
                    }
                  });
                },
                child: Container(
                  padding: const EdgeInsets.symmetric(horizontal: 10, vertical: 6),
                  decoration: BoxDecoration(
                    color: const Color(0xFF2196F3).withValues(alpha: 0.1),
                    borderRadius: BorderRadius.circular(12),
                    border: Border.all(
                      color: const Color(0xFF2196F3).withValues(alpha: 0.3),
                    ),
                  ),
                  child: Row(
                    mainAxisSize: MainAxisSize.min,
                    children: [
                      Icon(
                        _sortMode == 'added'
                          ? Icons.history
                          : _sortMode == 'expiration'
                            ? Icons.schedule
                            : Icons.priority_high,
                        size: 14,
                        color: const Color(0xFF2196F3),
                      ),
                      const SizedBox(width: 4),
                      Text(
                        _sortMode == 'added'
                          ? 'è¿½åŠ é †'
                          : _sortMode == 'expiration'
                            ? 'æœŸé™é †'
                            : 'ç·Šæ€¥åº¦é †',
                        style: const TextStyle(
                          color: Color(0xFF2196F3),
                          fontSize: 12,
                          fontWeight: FontWeight.w600,
                        ),
                      ),
                    ],
                  ),
                ),
              ),
            ],
          ),
          const SizedBox(height: 12),
          if (items.isEmpty)
            Container(
              padding: const EdgeInsets.all(32),
              decoration: BoxDecoration(
                color: Colors.white,
                borderRadius: BorderRadius.circular(16),
              ),
              child: Center(
                child: Column(
                  children: [
                    Text(category.icon, style: const TextStyle(fontSize: 48)),
                    const SizedBox(height: 12),
                    Text(
                      'ç¨®é¡ã‚’é¸ã‚“ã§\né£Ÿæã‚’è¿½åŠ ã—ã¾ã—ã‚‡ã†',
                      textAlign: TextAlign.center,
                      style: TextStyle(color: Colors.grey[600]),
                    ),
                  ],
                ),
              ),
            )
          else
            ...sortedItems.map((food) => _buildFoodCard(food, category)),
        ],
      ),
    );
  }

  Widget _buildTemplateSection(Category category) {
    final templates = _allTemplates
        .where((t) => t.categoryId == category.id && t.subCategoryId == _selectedSubCategoryId)
        .toList();
    
    if (templates.isEmpty) return const SizedBox.shrink();
    
    final subCategory = defaultSubCategories.firstWhere(
      (s) => s.id == _selectedSubCategoryId,
      orElse: () => const SubCategory(id: '', name: '', icon: '', parentCategoryId: ''),
    );

    return Container(
      padding: const EdgeInsets.all(12),
      decoration: BoxDecoration(
        color: Colors.white,
        borderRadius: BorderRadius.circular(16),
        boxShadow: [
          BoxShadow(
            color: Colors.black.withValues(alpha: 0.05),
            blurRadius: 10,
            offset: const Offset(0, 2),
          ),
        ],
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Row(
            children: [
              Text(subCategory.icon, style: const TextStyle(fontSize: 18)),
              const SizedBox(width: 8),
              Text(
                '${subCategory.name}ã‚’ãƒ¯ãƒ³ã‚¿ãƒƒãƒ—è¿½åŠ ',
                style: TextStyle(
                  fontWeight: FontWeight.bold,
                  fontSize: 14,
                  color: category.color,
                ),
              ),
            ],
          ),
          const SizedBox(height: 10),
          Wrap(
            spacing: 8,
            runSpacing: 8,
            children: templates.map((template) => _buildTemplateButton(template, category)).toList(),
          ),
        ],
      ),
    );
  }

  Widget _buildTemplateButton(FoodTemplate template, Category category) {
    return Material(
      color: Colors.transparent,
      child: InkWell(
        onTap: () => _quickAddFromTemplate(template),
        borderRadius: BorderRadius.circular(12),
        child: Container(
          padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),
          decoration: BoxDecoration(
            color: category.color.withValues(alpha: 0.08),
            borderRadius: BorderRadius.circular(12),
            border: Border.all(
              color: category.color.withValues(alpha: 0.3),
              width: 1,
            ),
          ),
          child: Row(
            mainAxisSize: MainAxisSize.min,
            children: [
              Text(template.icon, style: const TextStyle(fontSize: 20)),
              const SizedBox(width: 6),
              Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                mainAxisSize: MainAxisSize.min,
                children: [
                  Text(
                    template.name,
                    style: TextStyle(
                      fontSize: 12,
                      fontWeight: FontWeight.w600,
                      color: Colors.grey[800],
                    ),
                  ),
                  Text(
                    '${template.defaultDays}æ—¥',
                    style: TextStyle(
                      fontSize: 10,
                      color: Colors.grey[500],
                    ),
                  ),
                ],
              ),
            ],
          ),
        ),
      ),
    );
  }

  Widget _buildFoodCard(FoodItem food, Category category) {
    Color statusColor;
    String statusText;
    IconData statusIcon;

    if (food.isExpired) {
      statusColor = const Color(0xFFE53935);
      statusText = 'æœŸé™åˆ‡ã‚Œ';
      statusIcon = Icons.error;
    } else if (food.isWarning) {
      statusColor = const Color(0xFFFF9800);
      statusText = 'ã‚ã¨${food.daysUntilExpiration}æ—¥';
      statusIcon = Icons.warning;
    } else {
      statusColor = const Color(0xFF4CAF50);
      statusText = 'ã‚ã¨${food.daysUntilExpiration}æ—¥';
      statusIcon = Icons.check_circle;
    }

    return Dismissible(
      key: Key(food.id),
      direction: DismissDirection.endToStart,
      background: Container(
        alignment: Alignment.centerRight,
        padding: const EdgeInsets.only(right: 20),
        margin: const EdgeInsets.only(bottom: 12),
        decoration: BoxDecoration(
          color: Colors.red,
          borderRadius: BorderRadius.circular(16),
        ),
        child: const Icon(Icons.delete, color: Colors.white),
      ),
      onDismissed: (_) => _deleteFood(food.id),
      child: GestureDetector(
        onTap: () => _showEditDialog(food, category),
        child: Container(
          margin: const EdgeInsets.only(bottom: 12),
          decoration: BoxDecoration(
            color: Colors.white,
            borderRadius: BorderRadius.circular(16),
            boxShadow: [
              BoxShadow(
                color: Colors.black.withValues(alpha: 0.05),
                blurRadius: 10,
                offset: const Offset(0, 2),
              ),
            ],
          ),
          child: ListTile(
            contentPadding: const EdgeInsets.symmetric(horizontal: 16, vertical: 8),
            leading: Container(
              width: 48,
              height: 48,
              decoration: BoxDecoration(
                color: category.color.withValues(alpha: 0.1),
                borderRadius: BorderRadius.circular(12),
              ),
              child: Center(
                child: Text(food.icon, style: const TextStyle(fontSize: 24)),
              ),
            ),
            title: Text(
              food.name,
              style: const TextStyle(fontWeight: FontWeight.w600, fontSize: 16),
            ),
            subtitle: Row(
              children: [
                Text(
                  'ã€œ ${food.expirationDate.month}/${food.expirationDate.day}',
                  style: TextStyle(color: Colors.grey[600], fontSize: 13),
                ),
                const SizedBox(width: 8),
                Icon(Icons.edit, size: 14, color: Colors.grey[400]),
                Text(
                  ' ã‚¿ãƒƒãƒ—ã§ç·¨é›†',
                  style: TextStyle(color: Colors.grey[400], fontSize: 11),
                ),
              ],
            ),
            trailing: Container(
              padding: const EdgeInsets.symmetric(horizontal: 10, vertical: 4),
              decoration: BoxDecoration(
                color: statusColor.withValues(alpha: 0.1),
                borderRadius: BorderRadius.circular(16),
              ),
              child: Row(
                mainAxisSize: MainAxisSize.min,
                children: [
                  Icon(statusIcon, size: 14, color: statusColor),
                  const SizedBox(width: 4),
                  Text(
                    statusText,
                    style: TextStyle(
                      color: statusColor,
                      fontWeight: FontWeight.bold,
                      fontSize: 12,
                    ),
                  ),
                ],
              ),
            ),
          ),
        ),
      ),
    );
  }

  void _showEditDialog(FoodItem food, Category category) {
    DateTime selectedDate = food.expirationDate;

    showModalBottomSheet(
      context: context,
      backgroundColor: Colors.transparent,
      builder: (context) => StatefulBuilder(
        builder: (context, setModalState) => Container(
          padding: const EdgeInsets.all(24),
          decoration: const BoxDecoration(
            color: Colors.white,
            borderRadius: BorderRadius.vertical(top: Radius.circular(24)),
          ),
          child: Column(
            mainAxisSize: MainAxisSize.min,
            children: [
              Container(
                width: 40,
                height: 4,
                decoration: BoxDecoration(
                  color: Colors.grey[300],
                  borderRadius: BorderRadius.circular(2),
                ),
              ),
              const SizedBox(height: 20),
              Row(
                children: [
                  Container(
                    width: 56,
                    height: 56,
                    decoration: BoxDecoration(
                      color: category.color.withValues(alpha: 0.1),
                      borderRadius: BorderRadius.circular(16),
                    ),
                    child: Center(
                      child: Text(food.icon, style: const TextStyle(fontSize: 32)),
                    ),
                  ),
                  const SizedBox(width: 16),
                  Expanded(
                    child: Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        Text(
                          food.name,
                          style: const TextStyle(
                            fontSize: 20,
                            fontWeight: FontWeight.bold,
                          ),
                        ),
                        Text(
                          'ç™»éŒ²æ—¥: ${food.createdAt.month}/${food.createdAt.day}',
                          style: TextStyle(color: Colors.grey[600], fontSize: 13),
                        ),
                      ],
                    ),
                  ),
                ],
              ),
              const SizedBox(height: 24),
              const Align(
                alignment: Alignment.centerLeft,
                child: Text('è³å‘³æœŸé™ã‚’å¤‰æ›´', style: TextStyle(fontWeight: FontWeight.w600)),
              ),
              const SizedBox(height: 12),
              GestureDetector(
                onTap: () async {
                  final date = await showDatePicker(
                    context: context,
                    initialDate: selectedDate,
                    firstDate: DateTime.now().subtract(const Duration(days: 30)),
                    lastDate: DateTime.now().add(const Duration(days: 365)),
                  );
                  if (date != null) {
                    setModalState(() => selectedDate = date);
                  }
                },
                child: Container(
                  padding: const EdgeInsets.all(16),
                  decoration: BoxDecoration(
                    color: const Color(0xFFF5F7FA),
                    borderRadius: BorderRadius.circular(12),
                    border: Border.all(color: category.color),
                  ),
                  child: Row(
                    children: [
                      Icon(Icons.calendar_today, color: category.color),
                      const SizedBox(width: 12),
                      Text(
                        '${selectedDate.year}/${selectedDate.month}/${selectedDate.day}',
                        style: const TextStyle(fontSize: 18, fontWeight: FontWeight.w600),
                      ),
                      const Spacer(),
                      const Icon(Icons.chevron_right, color: Colors.grey),
                    ],
                  ),
                ),
              ),
              const SizedBox(height: 8),
              // ã‚¯ã‚¤ãƒƒã‚¯æ—¥ä»˜å¤‰æ›´ãƒœã‚¿ãƒ³
              Wrap(
                spacing: 8,
                runSpacing: 8,
                alignment: WrapAlignment.center,
                children: [
                  _buildQuickDateButton('-1æ—¥', () {
                    setModalState(() {
                      selectedDate = selectedDate.subtract(const Duration(days: 1));
                    });
                  }, Colors.red),
                  _buildQuickDateButton('+1æ—¥', () {
                    setModalState(() {
                      selectedDate = selectedDate.add(const Duration(days: 1));
                    });
                  }, category.color),
                  _buildQuickDateButton('+3æ—¥', () {
                    setModalState(() {
                      selectedDate = selectedDate.add(const Duration(days: 3));
                    });
                  }, category.color),
                  _buildQuickDateButton('+7æ—¥', () {
                    setModalState(() {
                      selectedDate = selectedDate.add(const Duration(days: 7));
                    });
                  }, category.color),
                  _buildQuickDateButton('ä»Šæ—¥', () {
                    setModalState(() {
                      selectedDate = DateTime.now();
                    });
                  }, category.color),
                ],
              ),
              const SizedBox(height: 24),
              Row(
                children: [
                  Expanded(
                    child: OutlinedButton(
                      onPressed: () => Navigator.pop(context),
                      style: OutlinedButton.styleFrom(
                        padding: const EdgeInsets.symmetric(vertical: 14),
                        shape: RoundedRectangleBorder(
                          borderRadius: BorderRadius.circular(12),
                        ),
                      ),
                      child: const Text('ã‚­ãƒ£ãƒ³ã‚»ãƒ«'),
                    ),
                  ),
                  const SizedBox(width: 12),
                  Expanded(
                    flex: 2,
                    child: ElevatedButton(
                      onPressed: () {
                        final updatedFood = food.copyWith(expirationDate: selectedDate);
                        _updateFood(updatedFood);
                        Navigator.pop(context);
                        ScaffoldMessenger.of(context).showSnackBar(
                          SnackBar(
                            content: Text('${food.icon} ${food.name} ã®æœŸé™ã‚’æ›´æ–°ã—ã¾ã—ãŸ'),
                            backgroundColor: category.color,
                            duration: const Duration(seconds: 1),
                            behavior: SnackBarBehavior.floating,
                          ),
                        );
                      },
                      style: ElevatedButton.styleFrom(
                        backgroundColor: category.color,
                        foregroundColor: Colors.white,
                        padding: const EdgeInsets.symmetric(vertical: 14),
                        shape: RoundedRectangleBorder(
                          borderRadius: BorderRadius.circular(12),
                        ),
                      ),
                      child: const Text(
                        'ä¿å­˜ã™ã‚‹',
                        style: TextStyle(fontWeight: FontWeight.bold),
                      ),
                    ),
                  ),
                ],
              ),
            ],
          ),
        ),
      ),
    );
  }

  Widget _buildQuickDateButton(String label, VoidCallback onTap, Color color) {
    return GestureDetector(
      onTap: onTap,
      child: Container(
        padding: const EdgeInsets.symmetric(horizontal: 14, vertical: 8),
        decoration: BoxDecoration(
          color: color.withValues(alpha: 0.1),
          borderRadius: BorderRadius.circular(20),
        ),
        child: Text(
          label,
          style: TextStyle(
            color: color,
            fontWeight: FontWeight.w600,
            fontSize: 13,
          ),
        ),
      ),
    );
  }

  void _showAddDialog() {
    final nameController = TextEditingController();
    String selectedCategoryId = defaultCategories[_tabController.index].id;
    String selectedIcon = 'ğŸ½ï¸';
    DateTime selectedDate = DateTime.now().add(const Duration(days: 7));
    int defaultDays = 7;
    bool saveAsTemplate = false;

    final iconOptions = ['ğŸ½ï¸', 'ğŸ¥—', 'ğŸ±', 'ğŸ¥˜', 'ğŸ²', 'ğŸ¥™', 'ğŸŒ®', 'ğŸŒ¯', 'ğŸ›', 'ğŸ', 'ğŸ¥ª', 'ğŸ”', 'ğŸŸ', 'ğŸ•', 'ğŸŒ­', 'ğŸ¥“', 'ğŸ—', 'ğŸ–', 'ğŸ¦´', 'ğŸŒ¶ï¸', 'ğŸ«‘', 'ğŸ¥’', 'ğŸ¥•', 'ğŸ§…', 'ğŸ§„', 'ğŸ¥”', 'ğŸ ', 'ğŸ«˜', 'ğŸ¥œ', 'ğŸ‡', 'ğŸˆ', 'ğŸ‰', 'ğŸŠ', 'ğŸ‹', 'ğŸŒ', 'ğŸ', 'ğŸ¥­', 'ğŸ', 'ğŸ', 'ğŸ', 'ğŸ‘', 'ğŸ’', 'ğŸ“', 'ğŸ«', 'ğŸ¥', 'ğŸŸ', 'ğŸ¦', 'ğŸ¦‘', 'ğŸš', 'ğŸ¥©', 'ğŸ¥›', 'ğŸ¥š', 'ğŸ§€', 'ğŸ§ˆ', 'ğŸ', 'ğŸ¥', 'ğŸ¥–'];

    showModalBottomSheet(
      context: context,
      isScrollControlled: true,
      backgroundColor: Colors.transparent,
      builder: (context) => StatefulBuilder(
        builder: (context, setModalState) => Container(
          height: MediaQuery.of(context).size.height * 0.85,
          padding: EdgeInsets.only(
            bottom: MediaQuery.of(context).viewInsets.bottom,
          ),
          decoration: const BoxDecoration(
            color: Colors.white,
            borderRadius: BorderRadius.vertical(top: Radius.circular(24)),
          ),
          child: SingleChildScrollView(
            padding: const EdgeInsets.all(24),
            child: Column(
              mainAxisSize: MainAxisSize.min,
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Center(
                  child: Container(
                    width: 40,
                    height: 4,
                    decoration: BoxDecoration(
                      color: Colors.grey[300],
                      borderRadius: BorderRadius.circular(2),
                    ),
                  ),
                ),
                const SizedBox(height: 20),
                const Text(
                  'ã‚«ã‚¹ã‚¿ãƒ é£Ÿæã‚’è¿½åŠ ',
                  style: TextStyle(fontSize: 20, fontWeight: FontWeight.bold),
                ),
                const SizedBox(height: 20),

                const Text('ã‚¢ã‚¤ã‚³ãƒ³', style: TextStyle(fontWeight: FontWeight.w600)),
                const SizedBox(height: 8),
                Container(
                  height: 100,
                  decoration: BoxDecoration(
                    color: const Color(0xFFF5F7FA),
                    borderRadius: BorderRadius.circular(12),
                  ),
                  child: GridView.builder(
                    padding: const EdgeInsets.all(8),
                    gridDelegate: const SliverGridDelegateWithFixedCrossAxisCount(
                      crossAxisCount: 10,
                      mainAxisSpacing: 4,
                      crossAxisSpacing: 4,
                    ),
                    itemCount: iconOptions.length,
                    itemBuilder: (context, index) {
                      final icon = iconOptions[index];
                      final isSelected = selectedIcon == icon;
                      return GestureDetector(
                        onTap: () => setModalState(() => selectedIcon = icon),
                        child: Container(
                          decoration: BoxDecoration(
                            color: isSelected ? const Color(0xFF2196F3) : Colors.white,
                            borderRadius: BorderRadius.circular(6),
                          ),
                          child: Center(
                            child: Text(icon, style: const TextStyle(fontSize: 18)),
                          ),
                        ),
                      );
                    },
                  ),
                ),
                const SizedBox(height: 16),

                TextField(
                  controller: nameController,
                  decoration: InputDecoration(
                    labelText: 'é£Ÿæå',
                    hintText: 'ä¾‹: æ‰‹ä½œã‚Šã‚µãƒ©ãƒ€',
                    prefixIcon: Text(selectedIcon, style: const TextStyle(fontSize: 20)),
                    prefixIconConstraints: const BoxConstraints(minWidth: 48),
                    border: OutlineInputBorder(borderRadius: BorderRadius.circular(12)),
                    filled: true,
                    fillColor: const Color(0xFFF5F7FA),
                  ),
                ),
                const SizedBox(height: 16),

                const Text('ã‚«ãƒ†ã‚´ãƒª', style: TextStyle(fontWeight: FontWeight.w600)),
                const SizedBox(height: 8),
                Row(
                  children: defaultCategories.map((cat) {
                    final isSelected = selectedCategoryId == cat.id;
                    return Expanded(
                      child: GestureDetector(
                        onTap: () => setModalState(() => selectedCategoryId = cat.id),
                        child: Container(
                          margin: const EdgeInsets.symmetric(horizontal: 4),
                          padding: const EdgeInsets.symmetric(vertical: 12),
                          decoration: BoxDecoration(
                            color: isSelected ? cat.color : Colors.grey[100],
                            borderRadius: BorderRadius.circular(12),
                          ),
                          child: Column(
                            children: [
                              Text(cat.icon, style: const TextStyle(fontSize: 24)),
                              const SizedBox(height: 4),
                              Text(
                                cat.name,
                                style: TextStyle(
                                  color: isSelected ? Colors.white : Colors.grey[700],
                                  fontWeight: FontWeight.w600,
                                  fontSize: 12,
                                ),
                              ),
                            ],
                          ),
                        ),
                      ),
                    );
                  }).toList(),
                ),
                const SizedBox(height: 16),

                const Text('è³å‘³æœŸé™', style: TextStyle(fontWeight: FontWeight.w600)),
                const SizedBox(height: 8),
                GestureDetector(
                  onTap: () async {
                    final date = await showDatePicker(
                      context: context,
                      initialDate: selectedDate,
                      firstDate: DateTime.now(),
                      lastDate: DateTime.now().add(const Duration(days: 365)),
                    );
                    if (date != null) {
                      setModalState(() {
                        selectedDate = date;
                        defaultDays = date.difference(DateTime.now()).inDays;
                      });
                    }
                  },
                  child: Container(
                    padding: const EdgeInsets.all(16),
                    decoration: BoxDecoration(
                      color: const Color(0xFFF5F7FA),
                      borderRadius: BorderRadius.circular(12),
                      border: Border.all(color: Colors.grey[300]!),
                    ),
                    child: Row(
                      children: [
                        const Icon(Icons.calendar_today, color: Color(0xFF2196F3)),
                        const SizedBox(width: 12),
                        Text(
                          '${selectedDate.year}/${selectedDate.month}/${selectedDate.day}',
                          style: const TextStyle(fontSize: 16),
                        ),
                        const Spacer(),
                        const Icon(Icons.chevron_right, color: Colors.grey),
                      ],
                    ),
                  ),
                ),
                const SizedBox(height: 16),

                Container(
                  padding: const EdgeInsets.all(12),
                  decoration: BoxDecoration(
                    color: const Color(0xFFFFF8E1),
                    borderRadius: BorderRadius.circular(12),
                  ),
                  child: Row(
                    children: [
                      Checkbox(
                        value: saveAsTemplate,
                        onChanged: (v) => setModalState(() => saveAsTemplate = v ?? false),
                        activeColor: const Color(0xFFFF9800),
                      ),
                      const Expanded(
                        child: Text('ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã¨ã—ã¦ä¿å­˜', style: TextStyle(fontSize: 13)),
                      ),
                      const Icon(Icons.bookmark, color: Color(0xFFFF9800)),
                    ],
                  ),
                ),
                const SizedBox(height: 24),

                SizedBox(
                  width: double.infinity,
                  child: ElevatedButton(
                    onPressed: () {
                      if (nameController.text.trim().isEmpty) return;
                      
                      final food = FoodItem(
                        id: DateTime.now().millisecondsSinceEpoch.toString(),
                        name: nameController.text.trim(),
                        icon: selectedIcon,
                        categoryId: selectedCategoryId,
                        expirationDate: selectedDate,
                      );
                      _addFood(food);

                      if (saveAsTemplate) {
                        final template = FoodTemplate(
                          id: 'custom_${DateTime.now().millisecondsSinceEpoch}',
                          name: nameController.text.trim(),
                          icon: selectedIcon,
                          categoryId: selectedCategoryId,
                          subCategoryId: 'other',
                          defaultDays: defaultDays,
                        );
                        _addCustomTemplate(template);
                      }

                      Navigator.pop(context);
                    },
                    style: ElevatedButton.styleFrom(
                      backgroundColor: const Color(0xFF2196F3),
                      foregroundColor: Colors.white,
                      padding: const EdgeInsets.symmetric(vertical: 16),
                      shape: RoundedRectangleBorder(
                        borderRadius: BorderRadius.circular(12),
                      ),
                    ),
                    child: const Text(
                      'è¿½åŠ ã™ã‚‹',
                      style: TextStyle(fontSize: 16, fontWeight: FontWeight.bold),
                    ),
                  ),
                ),
              ],
            ),
          ),
        ),
      ),
    );
  }

  @override
  void dispose() {
    _tabController.dispose();
    super.dispose();
  }
}
